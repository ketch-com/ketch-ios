<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script>
        window.semaphore = window.semaphore || [];
        window.ketch = function () {
            window.semaphore.push(arguments)
        }

        // Triggering the full config to load on startup
        ketch('getFullConfig', function(config) {
            emitEvent("onConfigLoaded", [config])
        });

        // Simulating events similar to ones coming from lanyard.js
        // TODO: remove this once JS SDK covers all required events
        function emitEvent(event, args) {
            if (window.androidListener || (window.webkit && window.webkit.messageHandlers)) {
                const filteredArgs = []
                for (const arg of args) {
                    if (arg !== this) {
                        filteredArgs.push(arg)
                    }
                }
                let argument
                if (filteredArgs.length === 1 && typeof filteredArgs[0] === 'string') {
                    argument = filteredArgs[0]
                } else if (filteredArgs.length === 1) {
                    argument = JSON.stringify(filteredArgs[0])
                } else if (filteredArgs.length > 1) {
                    argument = JSON.stringify(filteredArgs)
                }
                if (window.androidListener && event in window.androidListener) {
                    if (filteredArgs.length === 0) {
                        window.androidListener[event]()
                    } else {
                        window.androidListener[event](argument)
                    }
                } else if ((window.webkit && window.webkit.messageHandlers) && event in window.webkit.messageHandlers) {
                    window.webkit.messageHandlers[event].postMessage(argument)
                } else {
                    console.warn(`Can't pass message to native code because '${event}' handler is not registered`)
                }
            }
        }

        // Simulating "error" event
        // Capturing all the unhandled crashes of Ketch Tag
        window.addEventListener("error", (event) => {
            const errorMessage = `${event.message}`;
            console.error('[Mobile SDK]', errorMessage);
            emitEvent("error", [errorMessage]);
        });
        // Capturing all the unhandled rejections of Ketch Tag
        window.addEventListener('unhandledrejection', (event) => {
            const errorMessage = `${event.reason.message}`;
            console.error('[Mobile SDK]', errorMessage);
            emitEvent("error", [errorMessage]);
        });
        // Capturing all the internal loggin for errors handled by Ketch Tag
        // TODO: Remove this once lanyard.js will emit error events
        // ((logger) => {
            // var oldLog = logger.log;
            // var oldWarn = logger.warn;
            // var oldErr = logger.error;
            // logger.log = (...args) => {
            //     emitEvent("log", [args.join(' ')]);
            //     oldLog(...args);
            // };
            // logger.warn = (...args) => {
            //     emitEvent("warning", [args.join(' ')]);
            //     oldWarn(...args);
            // };
            // TODO: we don't listed for these for now to avoid collisions with
            // logger.error = (...args) => {
            //    emitEvent("error", [args.join(' ')]);
            //    oldErr(...args);
            // };
        // })(window.console);

        // A temporary workaround to get banner/modal dimensions on tablets
        // TODO: remove this once there will be a way to get dialogs position from JS SDK
        function getDialogDimensions() {
            var domElem = document.querySelector('#lanyard_root div[role="dialog"]');
            if (!domElem) {
                return;
            }
            var domRect = domElem.getBoundingClientRect();
            if (domRect) {
                if (domRect.width > 0 && domRect.height > 0) {
                    var dialogDimensions = [domRect.width, domRect.height];
                    return dialogDimensions;
                }
            }
        }

        var dimensionsUpdateId = null;

        function stopDimensionsUpdate() {
          clearInterval(dimensionsUpdateId);
          // release our intervalID from the variable
          dimensionsUpdateId = null;
        }

        function triggerDialogEvent(experienceType) {
            if (dimensionsUpdateId) {
                  stopDimensionsUpdate();
            }
            dimensionsUpdateId = setInterval(() => {
                var dialogDimensions = getDialogDimensions();
                if (dialogDimensions) {
                    stopDimensionsUpdate();
                    emitEvent("hasShownExperience", [experienceType, dialogDimensions]);
                }
            }, 500);
        }

        // emulate hasShowsExperience after willShowExperience
        function hasShownExperiencePlugin(host, _config) {
            // Receive every consent change notification
            host.on('willShowExperience', experienceType => {
                triggerDialogEvent(experienceType);
            });
        }

        ketch('registerPlugin', hasShownExperiencePlugin);

        // Get query parameters
        let params = (new URL(document.location)).searchParams;

        // Get url override from query parameters
        let url = params.get("ketch_mobilesdk_url") || 'https://global.ketchcdn.com/web/v3';

        // Get property name from query parameters
        let propertyName = params.get("propertyName");

        // Get organization code from query parameters
        let orgCode = params.get("orgCode");

        var e = document.createElement("script");
        e.type = "text/javascript";
        e.src = `${url}/config/${orgCode}/${propertyName}/boot.js`;
        e.defer = e.async = !0;
        document.getElementsByTagName("head")[0].appendChild(e);
    </script>
</head>
<body>
</body>
</html>
